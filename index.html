<!doctype html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>Tangram Magazine</title>

    <!-- 3rd party libraries -->
        <!-- Leaflet -->
        <link rel="stylesheet" href="src/leaflet.css" />
        <script src="src/leaflet.js"></script>
        <!-- bog-standard leaflet URL hash -->
        <script type="text/javascript" src="https://cdn.rawgit.com/mlevans/leaflet-hash/master/leaflet-hash.js"></script>
        <!-- Main tangram library -->
        <script src="https://mapzen.com/tangram/0.8/tangram.min.js"></script>
        <!-- Spinning wheel -->
        <script src="src/spin.min.js"></script>
        <!-- Bootstrap -->
        <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
        <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
    <!-- End of 3rd party libraries -->

    <style>
            body {
                margin: 0px;
                border: 0px;
                padding: 0px;
                overflow: hidden;
            }

            #container {
                height: 100%;
                width: 100%;
                margin: 0px;
                padding: 0px;
                z-index: 0;
            }

            .nav {
                z-index: 1;
            }
            #map {
                height: 100%;
                width: 100%;
                margin: 0px;
                padding: 0px;
                background: rgba(0, 0, 0, 0);
            }

            #paparazzi_image {
                height: 100%;
                width: 100%;
                margin: 0px;
                padding: 0px;
                background: rgba(0, 0, 0, 0);
            }

            #paparazzi_log{
                height: 100%;
                width: 100%;
                margin: 0px;
                padding: 0px;
                background: white;
            }

            #url_container {
                width: 80%;
                z-index: 3;
                padding: 5px;
            }

            #url_input {
                width: 100%;
                height: 40px;
                font-size: 17px;
                font-family: helvetica, arial ,sans-serif;
                color: white;
                padding: 5px;
            }
        </style>
    </head>

    <body>
        <div id="container">
            <ul id="tabs" class="nav nav-tabs" data-tabs="tabs">
                <li role="presentation" class="active"><a data-toggle="tab" href="#map"><span class="glyphicon glyphicon-move" aria-hidden="true"></span></a></li>
                <li role="presentation" class="paparazzi_dep"><a data-toggle="tab" href="#paparazzi_image"><span class="glyphicon glyphicon-picture" aria-hidden="true"></span></a></li>
                <li role="presentation" class="paparazzi_dep"><a data-toggle="tab" href="#paparazzi_log"><span class="glyphicon glyphicon-console" aria-hidden="true"></span></a></li>
                <li id='url_container' >
                    <!-- <div id='url_container'> -->
                        <input type="url_input" class="form-control" value="https://tangrams.github.io/tangram-sandbox/styles/default.yaml" placeholder="https://tangrams.github.io/tangram-sandbox/styles/default.yaml" onchange="newURL(this)">
                    <!-- </div>  -->
                </li>
            </ul>
            <div id="my-tab-content" class="tab-content">
                <div id="map" class="tab-pane active" ></div>
                <div id="paparazzi_image" class="tab-pane"></div>
                <div id="paparazzi_log" class="tab-pane"></div>
            </div>
        </div>

        <!-- Demo module -->
        <script type="text/javascript">
            // Tab magic?
            jQuery(document).ready(function ($) {
                $('#tabs').tab();
            });

            // CONST
            var DEFAULT_STYLE = 'https://tangrams.github.io/tangram-sandbox/styles/default.yaml';
            var PAPARAZI_SERVER = 'http://54.175.238.166/';
            // PAPARAZI_SERVER = 'http://192.168.2.134:8080/';

            // global var
            var lastPos = {lat:40.70531887544228, lng: -74.00976419448853};
            var lastZoom = 16;
            var lastReq = "";
            var opts = {
                      lines: 11 // The number of lines to draw
                    , length: 28 // The length of each line
                    , width: 14 // The line thickness
                    , radius: 42 // The radius of the inner circle
                    , scale: 1 // Scales overall size of the spinner
                    , corners: 1 // Corner roundness (0..1)
                    , color: '#000' // #rgb or #rrggbb or array of colors
                    , opacity: 0.25 // Opacity of the lines
                    , rotate: 0 // The rotation offset
                    , direction: 1 // 1: clockwise, -1: counterclockwise
                    , speed: 1 // Rounds per second
                    , trail: 60 // Afterglow percentage
                    , fps: 20 // Frames per second when using setTimeout() as a fallback for CSS
                    , zIndex: 2e9 // The z-index (defaults to 2000000000)
                    , className: 'spinner' // The CSS class to assign to the spinner
                    , top: '50%' // Top position relative to parent
                    , left: '50%' // Left position relative to parent
                    , shadow: false // Whether to render a shadow
                    , hwaccel: false // Whether to use hardware acceleration
                    , position: 'absolute' // Element positioning
                }
            var spinner = new Spinner(opts)

            function parseQuery (qstr) {
                var query = {};
                var a = qstr.split('&');
                for (var i in a) {
                    var b = a[i].split('=');
                    query[decodeURIComponent(b[0])] = decodeURIComponent(b[1]);
                }
                return query;
            }

            function updateQuery (key, value, url) {
                if (!url) url = window.location.href;
                var re = new RegExp("([?&])" + key + "=.*?(&|#|$)(.*)", "gi"),
                    hash;

                if (re.test(url)) {
                    if (typeof value !== 'undefined' && value !== null)
                        return url.replace(re, '$1' + key + "=" + value + '$2$3');
                    else {
                        hash = url.split('#');
                        url = hash[0].replace(re, '$1$3').replace(/(&|\?)$/, '');
                        if (typeof hash[1] !== 'undefined' && hash[1] !== null) 
                            url += '#' + hash[1];
                        return url;
                    }
                }
                else {
                    if (typeof value !== 'undefined' && value !== null) {
                        var separator = url.indexOf('?') !== -1 ? '&' : '?';
                        hash = url.split('#');
                        url = hash[0] + separator + key + '=' + value;
                        if (typeof hash[1] !== 'undefined' && hash[1] !== null) 
                            url += '#' + hash[1];
                        return url;
                    }
                    else
                        return url;
                }
            }

            function isValidURL(str) {
                var re = /(http|https):\/\/(\w+:{0,1}\w*)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&%!\-\/]))?\.yaml/;
                return re.test(str);
            }

            function debounce(func, wait, immediate) {
                var timeout;
                return function() {
                    var context = this, args = arguments;
                    var later = function() {
                        timeout = null;
                        if (!immediate) func.apply(context, args);
                    };
                    var callNow = immediate && !timeout;
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                    if (callNow) func.apply(context, args);
                };
            };

            function startUpdate() {
                var tabs = document.getElementsByClassName("paparazzi_dep");
                for (var i = tabs.length - 1; i >= 0; i--) {
                    tabs[i].style.visibility = "hidden";
                }
                spinner = new Spinner().spin(document.getElementById('container'));
            }

            function finishUpdate() {
                var tabs = document.getElementsByClassName("paparazzi_dep");
                for (var i = tabs.length - 1; i >= 0; i--) {
                    tabs[i].style.visibility = "visible";
                }
                spinner.stop();
            }

            var updateImage = debounce(function() {
                var size = map.getSize();
                var width = size.x; //window.innerWidth;
                var height = size.y; //window.innerHeight;
                var container = document.getElementById("paparazzi_image");
                lastReq = PAPARAZI_SERVER+'?lat='+ lastPos.lat + '&lon=' + lastPos.lng + '&zoom=' + (lastZoom) + '&width=' + width + '&height=' + height + '&scene=' + window.style_file;
                var downloadingImage = new Image();
                downloadingImage.onload = function(){
                    container.innerHTML = "";
                    container.appendChild(this);
                    console.log('Loaded',lastReq)
                    document.getElementById("paparazzi_log").innerHTML='<object id="console_log" type="text/html" style="width: 100%; height:100%;" data="'+lastReq+'&ext=log'+'" ></object>';
                    document.getElementById("console_log").style.height = window.innerHeight + 'px';
                    finishUpdate();
                };
                startUpdate();
                downloadingImage.src = lastReq;
            }, 1000);

            var map = (function () {
                'use strict';

                /*** URL parsing ***/
                // leaflet-style URL hash pattern:
                // ?style.yaml#[zoom],[lat],[lng]
                var url_hash = window.location.hash.slice(1).split('/');
                if (url_hash.length == 3) {
                    lastZoom = parseFloat(url_hash[0]);
                    lastPos.lat = parseFloat(url_hash[1]);
                    lastPos.lng = parseFloat(url_hash[2]);
                }

                // Watch for a scene to load on the query string
                // ?scene=http://something/map.yaml
                window.style_file = DEFAULT_STYLE;
                var query = parseQuery(window.location.search.slice(1));
                if (query['scene'] && isValidURL(query['scene'])) {
                    window.style_file = query['scene'];
                }
                var map_url = document.getElementById('url_input');
                if (window.style_file !== DEFAULT_STYLE) {
                    map_url.value = window.style_file;
                }
        
                /*** Map ***/
                var map = L.map('map', {
                    maxZoom: 20,
                    trackResize: true,
                    scrollWheelZoom: (window.self === window.top) ? 'center' : false,
                    keyboard: false
                });

                var layer = Tangram.leafletLayer({
                    scene: window.style_file,
                    attribution: '| &copy; OSM contributors | <a href="https://mapzen.com/tangram" target="_blank">Tangram</a>'
                });

                // Save things to local variables... because is easy :/
                window.map = map;
                window.layer = layer;
                window.scene = layer.scene;

                // Initialize Tangram
                map.setView([lastPos.lat, lastPos.lng], lastZoom);
                var hash = new L.Hash(map);

                // Resize map to window
                function resizeMap() {
                    document.getElementById('map').style.width = window.innerWidth + 'px';
                    document.getElementById('map').style.height = window.innerHeight + 'px';
                    map.invalidateSize(false);
                    updateImage();
                }

                window.addEventListener('resize', resizeMap);
                resizeMap();

                window.addEventListener('load', function () {
                    // Scene initialized
                    layer.addTo(map);
                });

                // On drag
                map.on('dragend', function () {
                    var pos = map.getCenter();
                    if (pos.lat != lastPos.lat ||
                        pos.lng != lastPos.lng ) {
                        lastPos = pos;
                        updateImage();
                    }
                });

                // On Zoom
                map.on('zoomend', function () {
                    var zoom = map.getZoom();
                    if (zoom != lastZoom) {
                        lastZoom = zoom;
                        updateImage();
                    }
                });

                //disable mousewheel zoom if iframed
                if (window.self !== window.top) {
                    map.scrollWheelZoom.disable();
                }
                return map;
            }());

            // Every time someone change the URL to the .yaml scene file
            function newURL(e) {
                var style = e.value;
                window.location.href = updateQuery('scene',e.value);
            }
        </script>

        

        <!-- Adding a script block to post message to the parent container (think iframed demos) -->
        <script type="text/javascript">
          window.addEventListener("hashchange",function(){parent.postMessage(window.location.hash, "*")});
        </script>
    </body>
</html>
