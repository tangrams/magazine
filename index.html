<!doctype html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>Tangram Magazine</title>

    <!-- 3rd party libraries -->
        <!-- Leaflet -->
        <link rel="stylesheet" href="src/leaflet.css" />
        <script src="src/leaflet.js"></script>
        <!-- bog-standard leaflet URL hash -->
        <script type="text/javascript" src="https://cdn.rawgit.com/mlevans/leaflet-hash/master/leaflet-hash.js"></script>
        <!-- Main tangram library -->
        <script src="https://mapzen.com/tangram/0.8/tangram.min.js"></script>
    <!-- End of 3rd party libraries -->

    <style>
            body {
                margin: 0px;
                border: 0px;
                padding: 0px;
                overflow: hidden;
            }

            #map {
                position: absolute;
                background: black;
                height: 100%;
                width: 50%;
                margin: 0px;
                padding: 0px;
                background: rgba(0, 0, 0, 0);
                z-index: 0;
            }

            #map_es {
                position: fixed;
                right: 0px;
                top: 0px;
                max-width: 50%;
                height: 100%;
                object-fit: cover;
            }

            #url_container {
                position: fixed;
                bottom: 30px;
                left: 50%;
                transform: translate(-50%, 0px);
                width: 80%;
                z-index: 3;
                background-color: rgba(128, 128, 128, 0.51);
                padding: 5px;
                padding-right: 25px;
            }
            #url {
                width: 100%;
                height: 25px;
                font-size: 17px;
                font-family: helvetica, arial ,sans-serif;
                color: white;
                border-color: #444;
                border-width: 5px;
                border-style: solid;
                background: gray;
                padding: 5px;
            }
        </style>
    </head>

    <body>
        <div id="map"></div>
        <img id="map_es">
        <div id='url_container'>
            <input id="url" type="text" value="https://tangrams.github.io/tangram-sandbox/styles/default.yaml" onchange="newURL(this)">
        </div>

        <!-- Demo module -->
        <script type="text/javascript">
            // CONST
            var DEFAULT_STYLE = 'https://tangrams.github.io/tangram-sandbox/styles/default.yaml';
            var PAPARAZI_SERVER = 'http://54.175.238.166/';
            // PAPARAZI_SERVER = 'http://192.168.2.134:8080/';

            // global var
            var lastPos = {lat:40.70531887544228, lng: -74.00976419448853};
            var lastZoom = 16;

            function parseQuery (qstr) {
                var query = {};
                var a = qstr.split('&');
                for (var i in a) {
                    var b = a[i].split('=');
                    query[decodeURIComponent(b[0])] = decodeURIComponent(b[1]);
                }
                return query;
            }

            function updateQuery (key, value, url) {
                if (!url) url = window.location.href;
                var re = new RegExp("([?&])" + key + "=.*?(&|#|$)(.*)", "gi"),
                    hash;

                if (re.test(url)) {
                    if (typeof value !== 'undefined' && value !== null)
                        return url.replace(re, '$1' + key + "=" + value + '$2$3');
                    else {
                        hash = url.split('#');
                        url = hash[0].replace(re, '$1$3').replace(/(&|\?)$/, '');
                        if (typeof hash[1] !== 'undefined' && hash[1] !== null) 
                            url += '#' + hash[1];
                        return url;
                    }
                }
                else {
                    if (typeof value !== 'undefined' && value !== null) {
                        var separator = url.indexOf('?') !== -1 ? '&' : '?';
                        hash = url.split('#');
                        url = hash[0] + separator + key + '=' + value;
                        if (typeof hash[1] !== 'undefined' && hash[1] !== null) 
                            url += '#' + hash[1];
                        return url;
                    }
                    else
                        return url;
                }
            }

            function isValidURL(str) {
                var re = /(http|https):\/\/(\w+:{0,1}\w*)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&%!\-\/]))?\.yaml/;
                return re.test(str);
            }

            function debounce(func, wait, immediate) {
                var timeout;
                return function() {
                    var context = this, args = arguments;
                    var later = function() {
                        timeout = null;
                        if (!immediate) func.apply(context, args);
                    };
                    var callNow = immediate && !timeout;
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                    if (callNow) func.apply(context, args);
                };
            };

            var updateImage = debounce(function() {
                var size = map.getSize();
                var width = size.x; //window.innerWidth;
                var height = size.y; //window.innerHeight;
                var img = document.getElementById("map_es");
                var image_url = PAPARAZI_SERVER+'?lat='+ lastPos.lat + '&lon=' + lastPos.lng + '&zoom=' + (lastZoom) + '&width=' + width + '&height=' + height + '&scene=' + window.style_file;
                var downloadingImage = new Image();
                downloadingImage.onload = function(){
                    img.src = this.src;   
                    console.log('Loaded',image_url);
                };
                downloadingImage.src = image_url;
            }, 1000);

            var map = (function () {
                'use strict';

                /*** URL parsing ***/
                // leaflet-style URL hash pattern:
                // ?style.yaml#[zoom],[lat],[lng]
                var url_hash = window.location.hash.slice(1).split('/');
                var map_start_location = [lastPos.lat, lastPos.lng, lastZoom];
                if (url_hash.length == 3) {
                    map_start_location = [url_hash[1],url_hash[2], url_hash[0]];
                    lastZoom = url_hash[0];
                    lastPos.lat = url_hash[1];
                    lastPos.lng = url_hash[2];
                    // convert from strings
                    map_start_location = map_start_location.map(Number);
                }

                // Watch for a scene to load on the query string
                // ?scene=http://something/map.yaml
                window.style_file = DEFAULT_STYLE;
                var query = parseQuery(window.location.search.slice(1));
                if (query['scene'] && isValidURL(query['scene'])) {
                    window.style_file = query['scene'];
                }
                var map_url = document.getElementById('url');
                if (window.style_file !== DEFAULT_STYLE) {
                    map_url.value = window.style_file;
                }
        
                /*** Map ***/
                var map = L.map('map', {
                    maxZoom: 20,
                    trackResize: true,
                    scrollWheelZoom: (window.self === window.top) ? 'center' : false,
                    keyboard: false
                });

                var layer = Tangram.leafletLayer({
                    scene: window.style_file,
                    attribution: '| &copy; OSM contributors | <a href="https://mapzen.com/tangram" target="_blank">Tangram</a>'
                });

                // Save things to local variables... because is easy :/
                window.map = map;
                window.layer = layer;
                window.scene = layer.scene;

                // Initialize Tangram
                map.setView(map_start_location.slice(0, 2), map_start_location[2]);
                var hash = new L.Hash(map);

                // Resize map to window
                function resizeMap() {
                    document.getElementById('map').style.width = window.innerWidth/2. + 'px';
                    document.getElementById('map').style.height = window.innerHeight + 'px';
                    map.invalidateSize(false);
                    updateImage();
                }

                window.addEventListener('resize', resizeMap);
                resizeMap();

                window.addEventListener('load', function () {
                    // Scene initialized
                    layer.addTo(map);
                });

                // On drag
                map.on('dragend', function () {
                    var pos = map.getCenter();
                    if (pos.lat != lastPos.lat ||
                        pos.lng != lastPos.lng ) {
                        lastPos = pos;
                        updateImage();
                    }
                });

                // On Zoom
                map.on('zoomend', function () {
                    var zoom = map.getZoom();
                    if (zoom != lastZoom) {
                        lastZoom = zoom;
                        updateImage();
                    }
                });

                //disable mousewheel zoom if iframed
                if (window.self !== window.top) {
                    map.scrollWheelZoom.disable();
                }
                return map;
            }());

            // Every time someone change the URL to the .yaml scene file
            function newURL(e) {
                var style = e.value;
                window.location.href = updateQuery('scene',e.value);
            }
        </script>

        

        <!-- Adding a script block to post message to the parent container (think iframed demos) -->
        <script type="text/javascript">
          window.addEventListener("hashchange",function(){parent.postMessage(window.location.hash, "*")});
        </script>
        <!-- Mapzen bug & search bar -->
        <script src='https://mapzen.com/common/ui/mapzen-ui.min.js'></script>
        <script>
                MPZN.bug({
                name: 'Tangram',
                tweet: 'WebGL map insanity from @patriciogv, power by @mapzen!',
                repo: 'https://github.com/tangrams/tangram/'
            });
        </script>
    </body>
</html>
